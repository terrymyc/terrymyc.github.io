-- _extensions/publications-filter.lua

-- store every reference entry here
local allRefs = {}

-- Called once, before any other filter functions
function Pandoc(doc)
  -- pandoc.utils.references(doc) returns a table of all loaded refs
  allRefs = pandoc.utils.references(doc)
  return doc
end

-- Called on every Div in the document
function Div(el)
  local id = el.identifier
  -- only act on our two special divs
  local target
  if id == "refs-journal" then
    target = "journal"
  elseif id == "refs-conference" then
    target = "conference"
  else
    return nil
  end

  -- collect citation objects for matching entries
  local cites = {}
  for _, ref in ipairs(allRefs) do
    local kw = ref.fields and ref.fields.keywords or ""
    for word in kw:gmatch("([^,]+)") do
      if word:match("^%s*" .. target .. "%s*$") then
        -- each Citation takes a list of citation items
        table.insert(cites, pandoc.Citation({
          id = ref.id,
          prefix = {},
          suffix = {},
          mode = "AuthorInText",
          noteNum = 0,
          hash = 0
        }, {}))
        break
      end
    end
  end

  -- wrap in a Para so CiteProc will render a mini-bibliography here
  return pandoc.Div({ pandoc.Para(cites) }, el.attr)
end
